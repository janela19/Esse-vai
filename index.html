<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa planilha financeira ‚ù§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1rem; }
        .progress-bar { height: 100%; transition: width 0.5s ease-in-out; border-radius: 9999px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; color: #333; z-index: 100; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #feedback-message { z-index: 1000; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body class="p-4 sm:p-8">
    
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="mt-4">Carregando...</p>
    </div>

    <div id="tela-login" class="flex flex-col items-center justify-center min-h-screen hidden">
        <div class="p-8 bg-white rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-800">Aceder √† Planilha</h2>
            <p id="authError" class="text-red-500 mb-4 text-center h-4"></p>
            <label for="emailInput" class="block text-gray-700 text-sm font-bold mb-2">Email Partilhado:</label>
            <input type="email" id="emailInput" placeholder="email.casal@exemplo.com" class="border p-3 mb-2 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <label for="passwordInput" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
            <input type="password" id="passwordInput" placeholder="********" class="border p-3 mb-4 w-full rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-between gap-4">
                <button id="loginButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Entrar</button>
                <button id="registerButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Registar</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-10 border border-gray-200 hidden" id="main-content">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-800">Nossa planilha financeira ‚ù§</h1>
                <p class="text-gray-500">Organizar para vivermos mais alegres e despreocupados.</p>
            </div>
            <button id="logoutButton" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Sair</button>
        </div>

        <div class="flex justify-center items-center gap-4 mb-8 p-2 bg-gray-100 rounded-lg">
            <button id="mesAnteriorBtn" class="px-3 py-1 rounded hover:bg-gray-200 font-bold">&lt;</button>
            <h2 id="mesAtualTitulo" class="text-xl font-bold text-center text-gray-700 w-48"></h2>
            <button id="proximoMesBtn" class="px-3 py-1 rounded hover:bg-gray-200 font-bold">&gt;</button>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-purple-600 mb-4">üéØ Or√ßamento Mensal</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="categoriaNome" placeholder="Categoria (ex: Alimenta√ß√£o)" class="flex-grow p-3 rounded-lg border">
                <input type="number" id="categoriaValor" placeholder="Or√ßamento (R$)" class="flex-grow p-3 rounded-lg border">
                <button onclick="adicionarOrcamento()" class="bg-purple-500 text-white font-medium p-3 rounded-lg hover:bg-purple-600">Definir Or√ßamento</button>
            </div>
            <div id="listaOrcamentos" class="bg-gray-50 rounded-lg p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <hr class="my-8 border-t-2 border-dashed">

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-green-600 mb-4">üí∞ Receitas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4">
                <input type="text" id="receitaNome" placeholder="Nome da Receita (ex: Sal√°rio)" class="sm:col-span-2 p-3 rounded-lg border">
                <input type="number" id="receitaValor" placeholder="Valor (R$)" class="p-3 rounded-lg border">
                <input type="date" id="receitaData" class="p-3 rounded-lg border">
                <div class="flex gap-2">
                    <input type="number" id="receitaParcela" placeholder="x" class="w-1/2 p-3 rounded-lg border text-center" title="Parcela Atual">
                    <input type="number" id="receitaTotalParcelas" placeholder="de Y" class="w-1/2 p-3 rounded-lg border text-center" title="Total de Parcelas">
                </div>
                <button onclick="adicionarReceita()" class="sm:col-span-5 bg-green-500 text-white font-medium p-3 rounded-lg hover:bg-green-600">Adicionar Receita</button>
            </div>
            <div id="listaReceitas" class="bg-gray-50 rounded-lg p-4"></div>
            <div class="mt-4 text-lg font-semibold flex justify-between"><span>Total de Receitas:</span><span id="totalReceitas" class="font-bold text-green-600"></span></div>
        </div>

        <hr class="my-8 border-t-2 border-dashed">

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-red-600 mb-4">üè† Despesas Fixas</h2>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4">
                <input type="text" id="despesaFixaNome" placeholder="Nome (ex: Aluguel)" class="sm:col-span-2 p-3 rounded-lg border">
                <input type="number" id="despesaFixaValor" placeholder="Valor (R$)" class="p-3 rounded-lg border">
                <input type="date" id="despesaFixaData" class="p-3 rounded-lg border">
                 <div class="flex gap-2">
                    <input type="number" id="despesaFixaParcela" placeholder="x" class="w-1/2 p-3 rounded-lg border text-center" title="Parcela Atual">
                    <input type="number" id="despesaFixaTotalParcelas" placeholder="de Y" class="w-1/2 p-3 rounded-lg border text-center" title="Total de Parcelas">
                </div>
                <button onclick="adicionarDespesa('fixa')" class="sm:col-span-5 bg-red-500 text-white font-medium p-3 rounded-lg hover:bg-red-600">Adicionar Despesa Fixa</button>
            </div>
            <div id="listaDespesasFixas" class="bg-gray-50 rounded-lg p-4"></div>
        </div>
        
        <hr class="my-8 border-t-2 border-dashed">

        <div class="mb-8">
             <h2 class="text-2xl font-semibold text-orange-600 mb-4">üõí Despesas Vari√°veis</h2>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                <input type="text" id="despesaVariavelNome" placeholder="Nome (ex: Lanches)" class="sm:col-span-2 p-3 rounded-lg border">
                <input type="number" id="despesaVariavelValor" placeholder="Valor (R$)" class="p-3 rounded-lg border">
                <input type="date" id="despesaVariavelData" class="p-3 rounded-lg border">
                 <select id="despesaCategoria" class="sm:col-span-3 p-3 rounded-lg border"><option value="">Selecione uma categoria</option></select>
                <button onclick="adicionarDespesa('variavel')" class="bg-orange-500 text-white font-medium p-3 rounded-lg hover:bg-orange-600">Adicionar Despesa Vari√°vel</button>
            </div>
            <div id="listaDespesasVariaveis" class="bg-gray-50 rounded-lg p-4"></div>
        </div>

        <hr class="my-8 border-t-2 border-dashed">

        <div>
            <h2 class="text-2xl font-semibold text-blue-800 mb-4 text-center">üìä Resumo do M√™s</h2>
            <div class="bg-blue-100 p-6 rounded-lg shadow-inner">
                <div class="text-xl sm:text-2xl text-center font-bold"><span>Total de Despesas:</span><span id="totalDespesas" class="ml-2 font-bold text-red-600"></span></div>
                <div class="text-xl sm:text-2xl text-center font-bold mt-4"><span>Saldo Final:</span><span id="saldoFinal" class="ml-2"></span></div>
            </div>
        </div>
    </div>

    <div id="feedback-message" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-center p-4 px-6 rounded-full shadow-lg opacity-0 transition-opacity duration-300 ease-in-out hidden">
        <span class="text-3xl">‚ù§</span>
        <p id="feedback-text" class="text-base mt-1"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBv3WXi-ZNDYkGebzvqEtuqG_NYKpAHolQ",
  authDomain: "financas-10990.firebaseapp.com",
  databaseURL: "https://financas-10990-default-rtdb.firebaseio.com",
  projectId: "financas-10990",
  storageBucket: "financas-10990.firebasestorage.app",
  messagingSenderId: "1004648523304",
  appId: "1:1004648523304:web:dabdd7ceed7c88640cb71d",
  measurementId: "G-TSYWV6N6Y1"
};
        // DOM Elements
        const loadingDiv = document.getElementById('loading'), mainContentDiv = document.getElementById('main-content');
        const receitaNomeInput = document.getElementById('receitaNome'), receitaValorInput = document.getElementById('receitaValor'), receitaDataInput = document.getElementById('receitaData'), receitaParcelaInput = document.getElementById('receitaParcela'), receitaTotalParcelasInput = document.getElementById('receitaTotalParcelas');
        const despesaFixaNomeInput = document.getElementById('despesaFixaNome'), despesaFixaValorInput = document.getElementById('despesaFixaValor'), despesaFixaDataInput = document.getElementById('despesaFixaData'), despesaFixaParcelaInput = document.getElementById('despesaFixaParcela'), despesaFixaTotalParcelasInput = document.getElementById('despesaFixaTotalParcelas');
        const despesaVariavelNomeInput = document.getElementById('despesaVariavelNome'), despesaVariavelValorInput = document.getElementById('despesaVariavelValor'), despesaVariavelDataInput = document.getElementById('despesaVariavelData'), despesaCategoriaSelect = document.getElementById('despesaCategoria');
        const categoriaNomeInput = document.getElementById('categoriaNome'), categoriaValorInput = document.getElementById('categoriaValor');
        const listaReceitasDiv = document.getElementById('listaReceitas'), listaDespesasFixasDiv = document.getElementById('listaDespesasFixas'), listaDespesasVariaveisDiv = document.getElementById('listaDespesasVariaveis'), listaOrcamentosDiv = document.getElementById('listaOrcamentos');
        const totalReceitasSpan = document.getElementById('totalReceitas'), totalDespesasSpan = document.getElementById('totalDespesas'), saldoFinalSpan = document.getElementById('saldoFinal');
        const feedbackMessage = document.getElementById('feedback-message'), feedbackText = document.getElementById('feedback-text');
        const mesAtualTitulo = document.getElementById('mesAtualTitulo'), mesAnteriorBtn = document.getElementById('mesAnteriorBtn'), proximoMesBtn = document.getElementById('proximoMesBtn');
        
        let db, userId, receitas = [], despesas = [], orcamentos = {}, dataDeReferencia = new Date(), listeners = [];
        const feedbackMessages = ["Obrigado por fazer isso!", "Ei... j√° falei o qu√£o voc√™ √© incr√≠vel hoje?"];

        const initFirebase = () => {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                setupEventListeners();
                firebase.auth().onAuthStateChanged(handleAuthStateChanged);
            } catch (error) { console.error("Erro de inicializa√ß√£o:", error); document.body.innerHTML = '<p>Erro cr√≠tico ao inicializar.</p>'; }
        };

        const setupEventListeners = () => {
            document.getElementById('loginButton').addEventListener('click', () => handleAuthAction('signInWithEmailAndPassword'));
            document.getElementById('registerButton').addEventListener('click', () => handleAuthAction('createUserWithEmailAndPassword'));
            document.getElementById('logoutButton').addEventListener('click', () => firebase.auth().signOut());
            mesAnteriorBtn.addEventListener('click', () => navegarMes(-1));
            proximoMesBtn.addEventListener('click', () => navegarMes(1));
        };

        const handleAuthStateChanged = user => {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            if (user) {
                userId = user.uid;
                atualizarTituloMes();
                carregarDados();
                mainContentDiv.classList.remove('hidden');
                document.getElementById('tela-login').classList.add('hidden');
            } else {
                userId = null;
                receitas = []; despesas = []; orcamentos = {};
                renderizarECalcular();
                document.getElementById('tela-login').classList.remove('hidden');
                mainContentDiv.classList.add('hidden');
            }
            loadingDiv.classList.add('hidden');
        };

        const handleAuthAction = (action) => {
            const email = document.getElementById('emailInput').value, password = document.getElementById('passwordInput').value, authError = document.getElementById('authError');
            authError.textContent = '';
            firebase.auth()[action](email, password).catch(error => { authError.textContent = "Erro: " + error.message; });
        };
        
        const navegarMes = (direcao) => {
            dataDeReferencia.setDate(1);
            dataDeReferencia.setMonth(dataDeReferencia.getMonth() + direcao);
            atualizarTituloMes();
            carregarDados();
        };

        const atualizarTituloMes = () => { mesAtualTitulo.textContent = dataDeReferencia.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase()); };

        const carregarDados = () => {
            if (!userId) return;
            listeners.forEach(unsub => unsub()); listeners = [];

            const unsubOrcamentos = db.collection(`users/${userId}/orcamentos`).onSnapshot(snapshot => {
                orcamentos = {};
                snapshot.docs.forEach(doc => { orcamentos[doc.id] = doc.data(); });
                atualizarSelectCategorias();
                renderizarECalcular();
            }, error => console.error("ERRO ao carregar or√ßamentos:", error));

            const unsubReceitas = db.collection(`users/${userId}/receitas`).onSnapshot(snapshot => {
                const todasReceitas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                receitas = filtrarPorMes(todasReceitas, 'receita');
                renderizarECalcular();
            }, error => console.error("ERRO ao carregar receitas:", error));

            const unsubDespesas = db.collection(`users/${userId}/despesas`).onSnapshot(snapshot => {
                const todasDespesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                despesas = filtrarPorMes(todasDespesas, 'despesa');
                renderizarECalcular();
            }, error => console.error("ERRO ao carregar despesas:", error));
            
            listeners.push(unsubOrcamentos, unsubReceitas, unsubDespesas);
        };

        const filtrarPorMes = (items, tipoLista) => {
            const { ultimoDia } = getLimitesDoMes();
            return items.filter(item => {
                const itemDate = item.data ? new Date(item.data + 'T12:00:00') : (item.timestamp ? item.timestamp.toDate() : null);
                if (!itemDate) return false;
                if (item.serieId) {
                    const { primeiroDia, ultimoDia: fimDoMes } = getLimitesDoMes();
                    return itemDate >= primeiroDia && itemDate <= fimDoMes;
                }
                if (tipoLista === 'receita' || item.tipo === 'fixa') { return itemDate <= ultimoDia; }
                const { primeiroDia, ultimoDia: fimDoMesVariavel } = getLimitesDoMes();
                return itemDate >= primeiroDia && itemDate <= fimDoMesVariavel;
            });
        };
        
        const renderizarECalcular = () => { renderizarListas(); calcularTotais(); };

        const renderizarListas = () => {
            renderizarLista(listaReceitasDiv, receitas, 'receita');
            const despesasFixas = despesas.filter(d => d.tipo === 'fixa');
            const despesasVariaveis = despesas.filter(d => d.tipo === 'variavel');
            renderizarLista(listaDespesasFixasDiv, despesasFixas, 'despesaFixa');
            renderizarLista(listaDespesasVariaveisDiv, despesasVariaveis, 'despesaVariavel');
            renderizarOrcamentos();
        };
        
        const renderizarLista = (div, lista, tipo) => {
            div.innerHTML = lista.length === 0 ? `<p class="text-gray-400 italic">Nenhum item adicionado para este m√™s.</p>` : '';
            lista.sort((a, b) => new Date(a.data) - new Date(b.data));
            lista.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center py-2 border-b last:border-b-0';
                const nome = item.serieId ? `${item.nome} (${item.parcelaAtual}/${item.totalParcelas})` : item.nome;
                const categoriaSpan = item.categoria ? `<span class="text-xs text-gray-400">(${item.categoria})</span>` : '';
                const corValor = tipo === 'receita' ? 'text-green-600' : (item.tipo === 'fixa' ? 'text-red-600' : 'text-orange-600');
                itemDiv.innerHTML = `
                    <div class="flex flex-col"><span class="text-sm font-medium text-gray-600">${nome}</span>${categoriaSpan}</div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold ${corValor}">${formatarMoeda(item.valor)}</span>
                        <button onclick="editarItem('${item.id}', '${tipo}')" class="text-blue-500 hover:text-blue-700 p-1 text-xs">Editar</button>
                        <button onclick="removerItem('${item.id}', '${tipo}')" class="bg-red-100 text-red-600 p-1 rounded-full hover:bg-red-200">
                           <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
                div.appendChild(itemDiv);
            });
        };

        const renderizarOrcamentos = () => {
            listaOrcamentosDiv.innerHTML = Object.keys(orcamentos).length === 0 ? '<p class="text-gray-400 italic md:col-span-2">Nenhum or√ßamento definido.</p>' : '';
            Object.entries(orcamentos).forEach(([categoria, data]) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg p-4 flex flex-col justify-between border';
                const idSeguro = categoria.replace(/\s+/g, '-');
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-purple-700">${categoria}</span>
                        <div>
                           <button onclick="editarOrcamento('${categoria}')" class="text-blue-500 hover:text-blue-700 p-1 text-xs mr-1">Editar</button>
                           <button onclick="removerItem('${categoria}', 'orcamento')" class="bg-red-100 text-red-600 p-1 rounded-full hover:bg-red-200">
                               <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                           </button>
                        </div>
                    </div>
                    <div class="text-sm font-medium text-gray-500 mb-2"><span id="gasto-${idSeguro}" class="font-bold"></span> / ${formatarMoeda(data.valor)}</div>
                    <div class="progress-bar-container"><div id="progresso-${idSeguro}" class="progress-bar bg-purple-400" style="width: 0%;"></div></div>`;
                listaOrcamentosDiv.appendChild(card);
            });
            atualizarProgressoOrcamentos();
        };

        const getUniqueId = () => db.collection('users').doc().id;

        const adicionarItemComParcelas = async (colecao, docData, totalParcelas, parcelaAtual, data) => {
            const serieId = (totalParcelas > 1) ? getUniqueId() : null;
            const totalDeParcelasParaCriar = totalParcelas - parcelaAtual + 1;
            const batch = db.batch();
            
            for (let i = 0; i < totalDeParcelasParaCriar; i++) {
                const dataBase = new Date(data + 'T12:00:00');
                const dataParcela = new Date(dataBase.getFullYear(), dataBase.getMonth() + i, dataBase.getDate());
                
                const newDocRef = db.collection(`users/${userId}/${colecao}`).doc();
                const docFinal = { ...docData, data: dataParcela.toISOString().split('T')[0], parcelaAtual: parcelaAtual + i, totalParcelas, serieId, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                if (colecao === 'receitas') { delete docFinal.tipo; delete docFinal.categoria; }
                batch.set(newDocRef, docFinal);
            }
            await batch.commit();
        };
        
        window.adicionarReceita = () => {
            const nome = receitaNomeInput.value.trim(), valor = parseFloat(receitaValorInput.value), parcelaAtual = parseInt(receitaParcelaInput.value) || 1, totalParcelas = parseInt(receitaTotalParcelasInput.value) || 1;
            let data = receitaDataInput.value; if (!data) data = new Date().toISOString().split('T')[0];
            if (nome && !isNaN(valor) && valor > 0) {
                adicionarItemComParcelas('receitas', { nome, valor }, totalParcelas, parcelaAtual, data);
                [receitaNomeInput, receitaValorInput, receitaDataInput, receitaParcelaInput, receitaTotalParcelasInput].forEach(i => i.value = '');
            } else { alert("Por favor, preencha nome e valor v√°lidos."); }
        };
        
        window.adicionarDespesa = (tipo) => {
            let nome, valor, data, categoria = '', parcelaAtual = 1, totalParcelas = 1, inputsParaLimpar = [];
            if (tipo === 'fixa') {
                nome = despesaFixaNomeInput.value.trim(); valor = parseFloat(despesaFixaValorInput.value); data = despesaFixaDataInput.value;
                parcelaAtual = parseInt(despesaFixaParcelaInput.value) || 1; totalParcelas = parseInt(despesaFixaTotalParcelasInput.value) || 1;
                inputsParaLimpar = [despesaFixaNomeInput, despesaFixaValorInput, despesaFixaDataInput, despesaFixaParcelaInput, despesaFixaTotalParcelasInput];
            } else {
                nome = despesaVariavelNomeInput.value.trim(); valor = parseFloat(despesaVariavelValorInput.value); data = despesaVariavelDataInput.value;
                categoria = despesaCategoriaSelect.value;
                inputsParaLimpar = [despesaVariavelNomeInput, despesaVariavelValorInput, despesaVariavelDataInput, despesaCategoriaSelect];
            }
            if (!data) data = new Date().toISOString().split('T')[0];
            if (nome && !isNaN(valor) && valor > 0) {
                 const docData = { nome, valor, tipo, categoria };
                 adicionarItemComParcelas('despesas', docData, (tipo === 'fixa' ? totalParcelas : 1), (tipo === 'fixa' ? parcelaAtual : 1), data);
                 inputsParaLimpar.forEach(i => i.value = '');
                 if (tipo === 'variavel') showFeedback();
            } else { alert("Por favor, preencha nome e valor v√°lidos."); }
        };

        window.adicionarOrcamento = async () => {
            const nome = categoriaNomeInput.value.trim();
            const valor = parseFloat(categoriaValorInput.value);
            if (nome && !isNaN(valor) && valor > 0) {
                await db.collection(`users/${userId}/orcamentos`).doc(nome).set({ valor });
                categoriaNomeInput.value = ''; categoriaValorInput.value = '';
            } else { alert("Por favor, insira um nome e um valor v√°lido."); }
        };
        
        window.removerItem = async (id, tipo) => {
            const colecoes = { receita: 'receitas', despesaFixa: 'despesas', despesaVariavel: 'despesas', orcamento: 'orcamentos' };
            const colecao = colecoes[tipo]; if (!colecao) return;
            const docRef = db.collection(`users/${userId}/${colecao}`).doc(id);
            const doc = await docRef.get();
            if(!doc.exists) return;
            const item = doc.data();
            if (item.serieId) {
                const confirmacao = confirm("Este √© um item parcelado. Deseja remover esta e todas as parcelas futuras desta s√©rie?");
                if (!confirmacao) return;
                const querySnapshot = await db.collection(`users/${userId}/${colecao}`).where('serieId', '==', item.serieId).where('parcelaAtual', '>=', item.parcelaAtual).get();
                const batch = db.batch();
                querySnapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                alert("Parcelas futuras removidas com sucesso!");
            } else { await docRef.delete(); }
        };

        window.editarItem = async (id, tipo) => {
            const colecoes = { receita: 'receitas', despesaFixa: 'despesas', despesaVariavel: 'despesas' };
            const colecao = colecoes[tipo]; if (!colecao) return;
            
            const docRef = db.collection(`users/${userId}/${colecao}`).doc(id);
            const doc = await docRef.get();
            if (!doc.exists) return;
            
            const itemAtual = doc.data();

            if (itemAtual.serieId) {
                alert("Para editar um item parcelado, a melhor forma √© remover a s√©rie (usando o bot√£o de remover) e adicion√°-la novamente com os valores corretos.");
                return;
            }

            const nomeNovo = prompt("Editar nome:", itemAtual.nome); if(nomeNovo === null) return;
            const valorNovoStr = prompt("Editar valor:", itemAtual.valor); if(valorNovoStr === null) return;
            
            const valorNovo = parseFloat(valorNovoStr);
            if (!nomeNovo.trim() || isNaN(valorNovo) || valorNovo <= 0) return alert("Nome ou valor inv√°lido.");

            if (tipo !== 'despesaVariavel') {
                const totalParcelasStr = prompt("Deseja transformar este item em parcelas? Se sim, digite o n√∫mero TOTAL de parcelas (ex: 12). Deixe em branco para apenas salvar a edi√ß√£o.", "1");
                const totalParcelas = parseInt(totalParcelasStr) || 1;

                if (totalParcelas > 1) {
                    const parcelaAtualStr = prompt("Qual √© o n√∫mero da parcela ATUAL deste item (ex: 1)?", "1");
                    const parcelaAtual = parseInt(parcelaAtualStr) || 1;

                    if (parcelaAtual > 0 && parcelaAtual <= totalParcelas) {
                        const confirmacao = confirm(`Isto ir√° apagar o item original e criar uma nova s√©rie de ${totalParcelas} parcelas para '${nomeNovo}', come√ßando na parcela ${parcelaAtual}. Deseja continuar?`);
                        if (confirmacao) {
                            await docRef.delete();
                            const dataOriginal = itemAtual.data ? itemAtual.data : (itemAtual.timestamp ? itemAtual.timestamp.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
                            const docData = { nome: nomeNovo, valor: valorNovo, tipo: itemAtual.tipo, categoria: itemAtual.categoria };
                            adicionarItemComParcelas(colecao, docData, totalParcelas, parcelaAtual, dataOriginal);
                        }
                        return;
                    }
                }
            }
            await docRef.update({ nome: nomeNovo, valor: valorNovo });
        };
        
        window.editarOrcamento = async (nomeAntigo) => {
            const orcamentoAtual = orcamentos[nomeAntigo]; if (!orcamentoAtual) return;
            const nomeNovo = prompt("Editar nome da categoria:", nomeAntigo);
            const valorNovoStr = prompt("Editar valor do or√ßamento:", orcamentoAtual.valor);
            if (nomeNovo === null || valorNovoStr === null) return;
            const valorNovo = parseFloat(valorNovoStr);
            if (!nomeNovo.trim() || isNaN(valorNovo) || valorNovo <= 0) return alert("Nome ou valor inv√°lido.");
            try {
                if (nomeNovo !== nomeAntigo) {
                    await db.collection(`users/${userId}/orcamentos`).doc(nomeAntigo).delete();
                    await db.collection(`users/${userId}/orcamentos`).doc(nomeNovo).set({ valor: valorNovo });
                } else { await db.collection(`users/${userId}/orcamentos`).doc(nomeAntigo).update({ valor: valorNovo }); }
            } catch (e) { console.error("Erro ao atualizar or√ßamento: ", e); }
        };

        const formatarMoeda = (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
        const getLimitesDoMes = () => {
            const primeiroDia = new Date(dataDeReferencia.getFullYear(), dataDeReferencia.getMonth(), 1);
            const ultimoDia = new Date(dataDeReferencia.getFullYear(), dataDeReferencia.getMonth() + 1, 0);
            return { primeiroDia, ultimoDia };
        };
        const showFeedback = () => {
            feedbackText.textContent = feedbackMessages[Math.floor(Math.random() * feedbackMessages.length)];
            feedbackMessage.classList.remove('hidden');
            feedbackMessage.classList.remove('opacity-0');
            setTimeout(() => {
                feedbackMessage.classList.add('opacity-0');
                setTimeout(() => { feedbackMessage.classList.add('hidden'); }, 300);
            }, 2000);
        };
        const calcularTotais = () => {
            const totalReceitas = receitas.reduce((acc, item) => acc + item.valor, 0);
            const totalDespesas = despesas.reduce((acc, item) => acc + item.valor, 0);
            const saldoFinal = totalReceitas - totalDespesas;
            totalReceitasSpan.textContent = formatarMoeda(totalReceitas);
            totalDespesasSpan.textContent = formatarMoeda(totalDespesas);
            saldoFinalSpan.textContent = formatarMoeda(saldoFinal);
            saldoFinalSpan.classList.toggle('text-red-600', saldoFinal < 0);
            saldoFinalSpan.classList.toggle('text-green-600', saldoFinal >= 0);
            atualizarProgressoOrcamentos();
        };
        const atualizarSelectCategorias = () => {
            despesaCategoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            Object.keys(orcamentos).sort().forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                despesaCategoriaSelect.appendChild(option);
            });
        };
        const atualizarProgressoOrcamentos = () => {
            Object.keys(orcamentos).forEach(categoria => {
                const despesasDaCategoria = despesas.filter(d => d.tipo === 'variavel' && d.categoria === categoria);
                const totalGasto = despesasDaCategoria.reduce((acc, item) => acc + item.valor, 0);
                const orcamentoTotal = orcamentos[categoria].valor;
                const percentual = orcamentoTotal > 0 ? Math.min((totalGasto / orcamentoTotal) * 100, 100) : 0;
                const idSeguro = categoria.replace(/\s+/g, '-');
                const progressBar = document.querySelector(`#progresso-${idSeguro}`);
                const totalGastoSpan = document.querySelector(`#gasto-${idSeguro}`);
                if (progressBar) {
                    progressBar.style.width = `${percentual}%`;
                    progressBar.className = 'progress-bar';
                    if (percentual >= 100) progressBar.classList.add('bg-red-500');
                    else if (percentual > 75) progressBar.classList.add('bg-yellow-500');
                    else progressBar.classList.add('bg-purple-400');
                }
                if (totalGastoSpan) totalGastoSpan.textContent = `${formatarMoeda(totalGasto)}`;
            });
        };

        window.onload = initFirebase;
    </script>
</body>
</html>
